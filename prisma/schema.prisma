// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS NOVOS ---

// Define se a sessão é uma sala de equipe ou o estoque pessoal do usuário
enum SessaoModo {
  MULTIPLAYER  // Sessões de equipe, acessíveis via código ou convite
  INDIVIDUAL   // Sessão oculta, "Estoque Pessoal" do usuário
}

// Define o tipo de usuário (Admin ou Usuário comum)
enum UsuarioTipo {
  ADMIN       // Administrador (acesso total)
  USUARIO     // Usuário comum
}

model Usuario {
  id               Int             @id @default(autoincrement())
  email            String          @unique
  senha_hash       String
  created_at       DateTime        @default(now())

  // Novo campo: nome de exibição no app (pode ser nulo)
  display_name     String?         @db.VarChar(100)

  // Novo campo: modo/página preferida ao abrir o app
  preferred_mode   String?         @db.VarChar(50)
  
  // Campos de controle de acesso
  tipo                  UsuarioTipo     @default(USUARIO)
  modulo_importacao     Boolean         @default(true)
  modulo_livre          Boolean         @default(false)
  modulo_sala           Boolean         @default(false)
  ativo                 Boolean         @default(true)
  
  // Relações existentes (Modo Single-player - Mantidas para compatibilidade ou migração futura)
  contagens        Contagem[]
  produtos         Produto[]
  codigos_barras   CodigoBarras[]
  contagens_salvas ContagemSalva[]
  
  // Novas Relações (Modo Multiplayer / Arquitetura v2)
  sessoes          Sessao[]        @relation("AnfitriaoSessao") // O usuário é o "Anfitrião"
  participacoes    Participante[]  // Sessões onde o usuário é participante (inclui INDIVIDUAL)

  // ✅ NOVO: Sistema de Empresas (Clientes)
  empresas         Empresa[]       // Empresas cadastradas pelo usuário

  @@map("usuarios")
}

// ✅ NOVO: Modelo de Empresas (Clientes)
model Empresa {
  id            Int       @id @default(autoincrement())
  usuario_id    Int       // Dono da empresa (quem cadastrou)
  nome_fantasia String    @db.VarChar(200)
  razao_social  String?   @db.VarChar(200)
  cnpj          String?   @db.VarChar(18)
  ativo         Boolean   @default(true)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relacionamentos
  usuario       Usuario   @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  contagens     Contagem[]
  sessoes       Sessao[]  // ✅ Sessões também podem ter empresa

  // Índices
  @@index([usuario_id])
  @@index([ativo])
  @@unique([usuario_id, cnpj]) // CNPJ único por usuário (permite null)
  @@map("empresas")
}

// --- ENTIDADES (Arquitetura v2) ---

// A "Sala" de contagem
model Sessao {
  id            Int           @id @default(autoincrement())
  codigo_acesso String        @unique // Código curto (ex: #LOJA-01)
  nome          String        
  status        String        @default("ABERTA") // ABERTA, PAUSADA, FINALIZADA
  criado_em     DateTime      @default(now())
  finalizado_em DateTime?

  // NOVO: Diferencia contexto - MULTIPLAYER x INDIVIDUAL
  modo          SessaoModo    @default(MULTIPLAYER)

  anfitriao_id  Int
  anfitriao     Usuario       @relation("AnfitriaoSessao", fields: [anfitriao_id], references: [id])

  // ✅ NOVO: Empresa relacionada (opcional)
  empresa_id    Int?
  empresa       Empresa?      @relation(fields: [empresa_id], references: [id], onDelete: SetNull)

  participantes Participante[]
  movimentos    Movimento[]
  produtos      ProdutoSessao[] // Produtos vinculados especificamente a esta contagem

  @@index([empresa_id])
  @@map("sessoes")
}

// Quem está contando
model Participante {
  id        Int      @id @default(autoincrement())
  nome      String   // Ex: "Maria"
  sessao_id Int
  sessao    Sessao   @relation(fields: [sessao_id], references: [id], onDelete: Cascade)
  status    String   @default("ATIVO") // ATIVO, FINALIZADO
  entrou_em DateTime @default(now())

  // NOVO: elo com Usuario para multi-device no singleplayer
  usuario_id Int?
  usuario    Usuario? @relation(fields: [usuario_id], references: [id])

  movimentos Movimento[] // Histórico do que esse participante fez

  @@map("participantes")
}

// Event Sourcing simplificado
model Movimento {
  id              Int          @id @default(autoincrement()) // ID interno do banco
  
  // ID único gerado pelo cliente (UUID) para evitar duplicatas em caso de reenvio.
  id_movimento_cliente String  @unique 

  sessao_id       Int
  sessao          Sessao       @relation(fields: [sessao_id], references: [id], onDelete: Cascade)
  
  participante_id Int?         // Pode ser nulo se for o Anfitrião fazendo ajuste direto
  participante    Participante? @relation(fields: [participante_id], references: [id])
  
  codigo_barras   String
  quantidade      Decimal      @db.Decimal(10, 3) // O Delta (+1, +10, -1.5)
  tipo_local      String       @default("LOJA") // "LOJA" ou "ESTOQUE"
  data_hora       DateTime     @default(now())

  @@index([sessao_id, codigo_barras])
  @@map("movimentos")
}

// Tabela de ligação para saber quais produtos o Anfitrião importou para ESSA sessão
model ProdutoSessao {
  id             Int      @id @default(autoincrement())
  sessao_id      Int
  sessao         Sessao   @relation(fields: [sessao_id], references: [id], onDelete: Cascade)
  
  codigo_produto String
  descricao      String
  saldo_sistema  Decimal  @db.Decimal(10, 3) @default(0) // O saldo esperado (snapshot do ERP)
  codigo_barras  String?  // Código principal para facilitar o scan
  
  @@unique([sessao_id, codigo_produto])
  @@map("produtos_sessao")
}

// --- ENTIDADES LEGADO (Mantidas por enquanto) ---

model Produto {
  id             Int            @id @default(autoincrement())
  codigo_produto String
  descricao      String
  saldo_estoque  Decimal        @default(0) 
  
  // --- CAMPOS DE CLASSIFICAÇÃO E VALUATION ---
  categoria      String?  @db.VarChar(100) // Ex: "Bebidas" (Macro)
  subcategoria   String?  @db.VarChar(100) // Ex: "Cervejas", "Refrigerantes" (Micro)
  marca          String?  @db.VarChar(100) // Ex: "Heineken", "Coca-Cola"
  preco          Decimal? @db.Decimal(10, 2) // Preço sugerido/médio
  // -------------------------------------------
  tipo_cadastro  String   @default("TEMPORARIO") @db.VarChar(20)
  created_at     DateTime       @default(now())
  usuario_id     Int
  usuario        Usuario        @relation(fields: [usuario_id], references: [id])
  codigos_barras CodigoBarras[]
  itens_contados ItemContado[]

  @@unique([codigo_produto, usuario_id])
  @@map("produtos")
}

model CodigoBarras {
  codigo_de_barras String
  produto_id       Int
  created_at       DateTime @default(now())
  usuario_id       Int
  usuario          Usuario  @relation(fields: [usuario_id], references: [id])
  produto          Produto  @relation(fields: [produto_id], references: [id], onDelete: Cascade)

  @@id([codigo_de_barras, usuario_id])
  @@map("codigos_de_barras")
}

model Contagem {
  id             Int           @id @default(autoincrement())
  usuario_id     Int
  data_contagem  DateTime      @default(now())
  local_estoque  String        @default("loja-1")
  status         String        @default("em_andamento")
  observacoes    String?
  
  // ✅ NOVO: Empresa relacionada (opcional)
  empresa_id     Int?
  empresa        Empresa?      @relation(fields: [empresa_id], references: [id], onDelete: SetNull)
  
  usuario        Usuario       @relation(fields: [usuario_id], references: [id])
  itens_contados ItemContado[]

  @@index([empresa_id])
  @@map("contagens")
}

model ItemContado {
  id                      Int      @id @default(autoincrement())
  contagem_id             Int
  produto_id              Int
  codigo_de_barras        String
  quant_loja              Int      @default(0)
  quant_estoque           Int      @default(0)
  saldo_estoque_inicial   Int
  total                   Int
  data_hora               DateTime @default(now())

  contagem      Contagem     @relation(fields: [contagem_id], references: [id], onDelete: Cascade)
  produto       Produto      @relation(fields: [produto_id], references: [id])

  @@unique([contagem_id, produto_id])
  @@map("itens_contados")
}

model ContagemSalva {
  id           Int      @id @default(autoincrement())
  nome_arquivo String
  conteudo_csv String
  created_at   DateTime @default(now())
  usuario_id   Int
  usuario      Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("contagens_salvas")
}