generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                Int             @id @default(autoincrement())
  email             String          @unique
  senha_hash        String
  created_at        DateTime        @default(now())
  preferred_mode    String?         @db.VarChar(50)
  display_name      String?         @db.VarChar(100)
  tipo              UsuarioTipo     @default(USUARIO)
  modulo_importacao Boolean         @default(true)
  modulo_livre      Boolean         @default(false)
  modulo_sala       Boolean         @default(false)
   modulo_empresa    Boolean         @default(false)
  ativo             Boolean         @default(true)
  codigos_barras    CodigoBarras[]
  contagens         Contagem[]
  contagens_salvas  ContagemSalva[]
  empresas          Empresa[]
  participacoes     Participante[]
  produtos          Produto[]
  sessoes           Sessao[]        @relation("AnfitriaoSessao")

  @@index([ativo])
  @@index([tipo])
  @@map("usuarios")
}

model Empresa {
  id               Int             @id @default(autoincrement())
  usuario_id       Int
  nome_fantasia    String          @db.VarChar(200)
  razao_social     String?         @db.VarChar(200)
  cnpj             String?         @db.VarChar(18)
  ativo            Boolean         @default(true)
  created_at       DateTime        @default(now())
  updated_at       DateTime        @updatedAt
  contagens        Contagem[]
  contagens_salvas ContagemSalva[]
  usuario          Usuario         @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  sessoes          Sessao[]

  @@unique([usuario_id, cnpj])
  @@index([usuario_id])
  @@index([ativo])
  @@map("empresas")
}

model Sessao {
  id            Int             @id @default(autoincrement())
  codigo_acesso String          @unique
  nome          String
  criado_em     DateTime        @default(now())
  finalizado_em DateTime?
  anfitriao_id  Int
  modo          SessaoModo      @default(MULTIPLAYER)
  empresa_id    Int?
  status        StatusSessao    @default(ABERTA)
  movimentos    Movimento[]
  participantes Participante[]
  produtos      ProdutoSessao[]
  anfitriao     Usuario         @relation("AnfitriaoSessao", fields: [anfitriao_id], references: [id])
  empresa       Empresa?        @relation(fields: [empresa_id], references: [id])

  @@index([anfitriao_id])
  @@index([status])
  @@index([modo])
  @@index([empresa_id])
  @@index([anfitriao_id, status])
  @@map("sessoes")
}

model Participante {
  id         Int         @id @default(autoincrement())
  nome       String
  sessao_id  Int
  status     String      @default("ATIVO")
  entrou_em  DateTime    @default(now())
  usuario_id Int?
  movimentos Movimento[]
  sessao     Sessao      @relation(fields: [sessao_id], references: [id], onDelete: Cascade)
  usuario    Usuario?    @relation(fields: [usuario_id], references: [id])

  @@index([sessao_id])
  @@index([usuario_id])
  @@index([sessao_id, status])
  @@map("participantes")
}

model Movimento {
  id                   Int           @id @default(autoincrement())
  id_movimento_cliente String        @unique
  sessao_id            Int
  participante_id      Int?
  codigo_barras        String
  quantidade           Decimal       @db.Decimal(10, 3)
  data_hora            DateTime      @default(now())
  tipo_local           String        @default("LOJA")
  participante         Participante? @relation(fields: [participante_id], references: [id])
  sessao               Sessao        @relation(fields: [sessao_id], references: [id], onDelete: Cascade)

  @@index([sessao_id])
  @@index([sessao_id, codigo_barras])
  @@index([sessao_id, tipo_local])
  @@index([participante_id])
  @@index([codigo_barras])
  @@map("movimentos")
}

model ProdutoSessao {
  id             Int     @id @default(autoincrement())
  sessao_id      Int
  codigo_produto String
  descricao      String
  saldo_sistema  Decimal @default(0) @db.Decimal(10, 3)
  codigo_barras  String?
  sessao         Sessao  @relation(fields: [sessao_id], references: [id], onDelete: Cascade)

  @@unique([sessao_id, codigo_produto])
  @@index([sessao_id])
  @@index([codigo_barras])
  @@map("produtos_sessao")
}

model Produto {
  id             Int            @id @default(autoincrement())
  codigo_produto String
  descricao      String
  saldo_estoque  Decimal        @default(0)
  created_at     DateTime       @default(now())
  usuario_id     Int
  categoria      String?        @db.VarChar(100)
  marca          String?        @db.VarChar(100)
  preco          Decimal?       @db.Decimal(10, 2)
  subcategoria   String?        @db.VarChar(100)
  tipo_cadastro  String         @default("TEMPORARIO") @db.VarChar(20)
  codigos_barras CodigoBarras[]
  itens_contados ItemContado[]
  usuario        Usuario        @relation(fields: [usuario_id], references: [id])

  @@unique([codigo_produto, usuario_id])
  @@index([usuario_id])
  @@index([tipo_cadastro])
  @@index([usuario_id, tipo_cadastro])
  @@map("produtos")
}

model CodigoBarras {
  codigo_de_barras String
  produto_id       Int
  created_at       DateTime @default(now())
  usuario_id       Int
  produto          Produto  @relation(fields: [produto_id], references: [id], onDelete: Cascade)
  usuario          Usuario  @relation(fields: [usuario_id], references: [id])

  @@id([codigo_de_barras, usuario_id])
  @@index([produto_id])
  @@index([usuario_id])
  @@map("codigos_de_barras")
}

model Contagem {
  id             Int           @id @default(autoincrement())
  usuario_id     Int
  data_contagem  DateTime      @default(now())
  local_estoque  String        @default("loja-1")
  status         String        @default("em_andamento")
  observacoes    String?
  empresa_id     Int?
  empresa        Empresa?      @relation(fields: [empresa_id], references: [id])
  usuario        Usuario       @relation(fields: [usuario_id], references: [id])
  itens_contados ItemContado[]

  @@index([usuario_id])
  @@index([empresa_id])
  @@index([status])
  @@index([usuario_id, status])
  @@map("contagens")
}

model ItemContado {
  id                    Int      @id @default(autoincrement())
  contagem_id           Int
  produto_id            Int
  codigo_de_barras      String
  quant_loja            Int      @default(0)
  quant_estoque         Int      @default(0)
  saldo_estoque_inicial Int
  total                 Int
  data_hora             DateTime @default(now())
  contagem              Contagem @relation(fields: [contagem_id], references: [id], onDelete: Cascade)
  produto               Produto  @relation(fields: [produto_id], references: [id])

  @@unique([contagem_id, produto_id])
  @@index([contagem_id])
  @@index([produto_id])
  @@map("itens_contados")
}

model ContagemSalva {
  id           Int      @id @default(autoincrement())
  nome_arquivo String
  conteudo_csv String
  created_at   DateTime @default(now())
  usuario_id   Int
  empresa_id   Int?
  empresa      Empresa? @relation(fields: [empresa_id], references: [id])
  usuario      Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@index([empresa_id])
  @@index([usuario_id, created_at])
  @@map("contagens_salvas")
}

enum SessaoModo {
  MULTIPLAYER
  INDIVIDUAL
}

enum UsuarioTipo {
  ADMIN
  USUARIO
}

enum StatusSessao {
  ABERTA
  ENCERRANDO
  FINALIZADA
}